<div class="page" dir="rtl">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ 'feature.advanced_reports.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'feature.advanced_reports.title_desc' | translate }}</p>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">ğŸ” ÙÛŒÙ„ØªØ±Ù‡Ø§</h3>
    </div>
    <div class="card-content">
      <div class="filters-grid">
        <div class="form-group">
          <label>Ù¾Ø±ÙˆÚ˜Ù‡</label>
          <select [(ngModel)]="selectedProjectId" (ngModelChange)="onProjectChange()">
            <option value="">Ù‡Ù…Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</option>
            @for (p of projects; track p.id) {
              <option [value]="p.id">{{ p.name }}</option>
            }
          </select>
        </div>
        <div class="form-group">
          <label>Ø¹Ù…Ù„ÛŒØ§Øª</label>
          <select [(ngModel)]="selectedOperationId" (ngModelChange)="onOperationChange()" [disabled]="!selectedProjectId">
            <option value="">Ù‡Ù…Ù‡ Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§</option>
            @for (op of filteredOperations; track op.id) {
              <option [value]="op.id">{{ op.name }}</option>
            }
          </select>
        </div>
        <div class="form-group">
          <label>Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</label>
          <select [(ngModel)]="selectedTimeRange" (ngModelChange)="onTimeRangeChange()">
            @for (tr of timeRangeOptions; track tr.value) {
              <option [value]="tr.value">{{ tr.label }}</option>
            }
          </select>
        </div>
        <div class="form-group">
          <label>Ù†ÙˆØ¹ Ù†Ù…Ø§ÛŒØ´</label>
          <select [(ngModel)]="selectedViewType" (ngModelChange)="onViewTypeChange()">
            @for (vt of viewTypeOptions; track vt.value) {
              <option [value]="vt.value">{{ vt.label }}</option>
            }
          </select>
        </div>
      </div>
    </div>
  </div>

  @if (!hasData) {
    <!-- Empty State -->
    <div class="empty-state">
      <span class="empty-icon">ğŸ“­</span>
      <p class="empty-text">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
    </div>
  } @else {
    <!-- Stats Cards (4) -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-body">
          <div>
            <p class="stat-label">Ú©Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡</p>
            <p class="stat-value text-blue">{{ totalPlanned.toLocaleString() }}</p>
          </div>
          <span class="stat-icon">ğŸ“‹</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card-body">
          <div>
            <p class="stat-label">Ú©Ù„ ØªØ­Ù‚Ù‚</p>
            <p class="stat-value text-green">{{ totalAchieved.toLocaleString() }}</p>
          </div>
          <span class="stat-icon">âœ…</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card-body">
          <div>
            <p class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±Ø§Ù†Ø¯Ù…Ø§Ù†</p>
            <p class="stat-value text-purple">{{ avgEfficiency }}%</p>
          </div>
          <span class="stat-icon">ğŸ“Š</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card-body">
          <div>
            <p class="stat-label">Ø±ÙˆÙ†Ø¯ Ø¹Ù…Ù„Ú©Ø±Ø¯</p>
            <p class="stat-value" [class]="trendClass">{{ trendIndicator }} {{ trendLabel }}</p>
          </div>
          <span class="stat-icon">ğŸ“ˆ</span>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-bar">
      @for (tab of tabs; track tab.key) {
        <button
          class="tab-btn"
          [class.tab-active]="activeTab === tab.key"
          (click)="activeTab = $any(tab.key)">
          {{ tab.icon }} {{ tab.label }}
        </button>
      }
    </div>

    <!-- ===================== TAB 1: Chart â†’ Table ===================== -->
    @if (activeTab === 'chart-table') {
      <!-- Main data table based on timeRange -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ“… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ {{ getTimeRangeLabel() }}</h3>
        </div>
        <div class="card-content">
          <div class="table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>Ø±Ø¯ÛŒÙ</th>
                  <th>Ø¯ÙˆØ±Ù‡</th>
                  <th>Ø¨Ø±Ù†Ø§Ù…Ù‡</th>
                  <th>ØªØ­Ù‚Ù‚</th>
                  <th>Ø±Ø§Ù†Ø¯Ù…Ø§Ù†</th>
                  <th>Ù¾ÛŒØ´Ø±ÙØª</th>
                </tr>
              </thead>
              <tbody>
                @for (entry of processedData; track entry.label; let i = $index) {
                  <tr>
                    <td class="text-muted">{{ i + 1 }}</td>
                    <td class="font-medium">{{ entry.label }}</td>
                    <td>{{ entry.planned.toLocaleString() }}</td>
                    <td>{{ entry.achieved.toLocaleString() }}</td>
                    <td>
                      <span [class]="'eff-badge ' + getEfficiencyClass(entry.efficiency)">
                        {{ entry.efficiency }}%
                      </span>
                    </td>
                    <td>
                      <div class="progress-cell">
                        <div class="progress-bar">
                          <div
                            class="progress-bar-fill"
                            [class.fill-green]="entry.efficiency >= 95"
                            [class.fill-blue]="entry.efficiency >= 90 && entry.efficiency < 95"
                            [class.fill-yellow]="entry.efficiency >= 80 && entry.efficiency < 90"
                            [class.fill-red]="entry.efficiency < 80"
                            [style.width.%]="getBarWidth(entry.efficiency)">
                          </div>
                        </div>
                        <span class="progress-text">{{ entry.efficiency }}%</span>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Efficiency trend summary table -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ“ˆ Ø®Ù„Ø§ØµÙ‡ Ø±ÙˆÙ†Ø¯ Ø±Ø§Ù†Ø¯Ù…Ø§Ù†</h3>
        </div>
        <div class="card-content">
          <div class="table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>Ø¯ÙˆØ±Ù‡</th>
                  <th>Ø±Ø§Ù†Ø¯Ù…Ø§Ù†</th>
                  <th>ÙˆØ¶Ø¹ÛŒØª</th>
                </tr>
              </thead>
              <tbody>
                @for (entry of processedData; track entry.label; let i = $index) {
                  <tr>
                    <td class="font-medium">{{ entry.label }}</td>
                    <td>
                      <span [class]="'eff-badge ' + getEfficiencyClass(entry.efficiency)">
                        {{ entry.efficiency }}%
                      </span>
                    </td>
                    <td>
                      @if (i === 0) {
                        <span class="trend-indicator trend-neutral">â€”</span>
                      } @else if (entry.efficiency >= processedData[i - 1].efficiency) {
                        <span class="trend-indicator trend-up">â†‘ Ø¨Ù‡Ø¨ÙˆØ¯</span>
                      } @else {
                        <span class="trend-indicator trend-down">â†“ Ú©Ø§Ù‡Ø´</span>
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    }

    <!-- ===================== TAB 2: Data Table ===================== -->
    @if (activeTab === 'data-table') {
      @if (selectedViewType === 'trend') {
        <!-- Trend view data table -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ø±ÙˆÙ†Ø¯)</h3>
          </div>
          <div class="card-content">
            <div class="table-wrapper">
              <table class="table">
                <thead>
                  <tr>
                    <th>Ø±Ø¯ÛŒÙ</th>
                    <th>Ø¯ÙˆØ±Ù‡</th>
                    <th>Ø¨Ø±Ù†Ø§Ù…Ù‡</th>
                    <th>ØªØ­Ù‚Ù‚</th>
                    <th>Ø§Ø®ØªÙ„Ø§Ù</th>
                    <th>Ø±Ø§Ù†Ø¯Ù…Ø§Ù†</th>
                  </tr>
                </thead>
                <tbody>
                  @for (entry of processedData; track entry.label; let i = $index) {
                    <tr>
                      <td class="text-muted">{{ i + 1 }}</td>
                      <td class="font-medium">{{ entry.label }}</td>
                      <td>{{ entry.planned.toLocaleString() }}</td>
                      <td>{{ entry.achieved.toLocaleString() }}</td>
                      <td [class]="entry.achieved - entry.planned >= 0 ? 'text-green font-medium' : 'text-red font-medium'">
                        {{ (entry.achieved - entry.planned).toLocaleString() }}
                      </td>
                      <td>
                        <span [class]="'eff-badge ' + getEfficiencyClass(entry.efficiency)">
                          {{ entry.efficiency }}%
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
      } @else {
        <!-- Cumulative view data table -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (ØªØ¬Ù…ÛŒØ¹ÛŒ)</h3>
          </div>
          <div class="card-content">
            <div class="table-wrapper">
              <table class="table">
                <thead>
                  <tr>
                    <th>Ø±Ø¯ÛŒÙ</th>
                    <th>Ø¯ÙˆØ±Ù‡</th>
                    <th>Ø¨Ø±Ù†Ø§Ù…Ù‡</th>
                    <th>ØªØ­Ù‚Ù‚</th>
                    <th>Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªØ¬Ù…ÛŒØ¹ÛŒ</th>
                    <th>ØªØ­Ù‚Ù‚ ØªØ¬Ù…ÛŒØ¹ÛŒ</th>
                    <th>Ø±Ø§Ù†Ø¯Ù…Ø§Ù† ØªØ¬Ù…ÛŒØ¹ÛŒ</th>
                  </tr>
                </thead>
                <tbody>
                  @for (entry of cumulativeData; track entry.label; let i = $index) {
                    <tr>
                      <td class="text-muted">{{ i + 1 }}</td>
                      <td class="font-medium">{{ entry.label }}</td>
                      <td>{{ entry.planned.toLocaleString() }}</td>
                      <td>{{ entry.achieved.toLocaleString() }}</td>
                      <td class="font-medium">{{ entry.cumulativePlanned.toLocaleString() }}</td>
                      <td class="font-medium">{{ entry.cumulativeAchieved.toLocaleString() }}</td>
                      <td>
                        <span [class]="'eff-badge ' + getEfficiencyClass(entry.cumulativeEfficiency)">
                          {{ entry.cumulativeEfficiency }}%
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
      }
    }

    <!-- Summary Cards (Best / Worst) -->
    <div class="summary-grid">
      @if (bestPeriod) {
        <div class="summary-card summary-best">
          <div class="summary-icon">ğŸ†</div>
          <div class="summary-content">
            <h4 class="summary-title">Ø¨Ù‡ØªØ±ÛŒÙ† Ø¯ÙˆØ±Ù‡</h4>
            <p class="summary-label">{{ bestPeriod.label }}</p>
            <p class="summary-value text-green">{{ bestPeriod.efficiency }}%</p>
          </div>
        </div>
      }
      @if (worstPeriod) {
        <div class="summary-card summary-worst">
          <div class="summary-icon">âš ï¸</div>
          <div class="summary-content">
            <h4 class="summary-title">Ø¶Ø¹ÛŒÙâ€ŒØªØ±ÛŒÙ† Ø¯ÙˆØ±Ù‡</h4>
            <p class="summary-label">{{ worstPeriod.label }}</p>
            <p class="summary-value text-red">{{ worstPeriod.efficiency }}%</p>
          </div>
        </div>
      }
    </div>
  }
</div>
