<div class="page" dir="rtl">
  <!-- ==================== LIST VIEW ==================== -->
  @if (!showForm) {
    <!-- Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">{{ 'feature.achievements.title' | translate }}</h1>
        <p class="page-subtitle">{{ 'feature.achievements.title_desc' | translate }}</p>
      </div>
      <button class="btn btn-primary" (click)="openAddForm()">
        â• Ø«Ø¨Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¬Ø¯ÛŒØ¯
      </button>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-body">
          <div>
            <p class="stat-label">Ú©Ù„ Ø¹Ù…Ù„Ú©Ø±Ø¯Ù‡Ø§</p>
            <p class="stat-value">{{ stats.total }}</p>
          </div>
          <span class="stat-icon">ğŸ“Š</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card-body">
          <div>
            <p class="stat-label">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</p>
            <p class="stat-value text-green">{{ stats.completed }}</p>
          </div>
          <span class="stat-icon">âœ…</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card-body">
          <div>
            <p class="stat-label">ØªÚ©Ù…ÛŒÙ„ Ø¬Ø²Ø¦ÛŒ</p>
            <p class="stat-value text-yellow">{{ stats.partial }}</p>
          </div>
          <span class="stat-icon">âš ï¸</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card-body">
          <div>
            <p class="stat-label">Ø¹Ø¯Ù… ØªØ­Ù‚Ù‚</p>
            <p class="stat-value text-red">{{ stats.failed }}</p>
          </div>
          <span class="stat-icon">âŒ</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-card-body">
          <div>
            <p class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¨Ø§Ø²Ø¯Ù‡ÛŒ</p>
            <p class="stat-value text-blue">{{ stats.avgEfficiency }}%</p>
          </div>
          <span class="stat-icon">ğŸ“ˆ</span>
        </div>
      </div>
    </div>

    <!-- Achievements Table -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Ù„ÛŒØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯Ù‡Ø§</h3>
      </div>
      <div class="card-content">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>ØªØ§Ø±ÛŒØ®</th>
                <th>Ù¾Ø±ÙˆÚ˜Ù‡</th>
                <th>Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡</th>
                <th>Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ / ÙˆØ§Ø­Ø¯</th>
                <th>Ù…Ù‚Ø¯Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯ / ÙˆØ§Ø­Ø¯</th>
                <th>Ø¨Ø§Ø²Ø¯Ù‡ÛŒ</th>
                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                <th>Ø¯Ù„Ø§ÛŒÙ„ ØªØ£Ø®ÛŒØ±</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody>
              @for (ach of allAchievements; track ach.id) {
                <tr>
                  <td>{{ ach.date }}</td>
                  <td>{{ getProjectName(ach.projectId) }}</td>
                  <td>{{ getPlanTitle(ach.planId) }}</td>
                  <td>
                    <span class="font-medium">{{ ach.plannedAmount }}</span>
                    <span class="text-muted text-sm"> {{ getUnitLabel(ach.unit) }}</span>
                  </td>
                  <td>
                    <span class="font-medium">{{ ach.achievedAmount }}</span>
                    <span class="text-muted text-sm"> {{ getUnitLabel(ach.unit) }}</span>
                  </td>
                  <td>
                    <span [class]="'efficiency-badge ' + getEfficiencyClass(ach.efficiency)">
                      {{ getEfficiencyIcon(ach.efficiency) }} {{ ach.efficiency }}%
                    </span>
                  </td>
                  <td>
                    <span [class]="'badge ' + getStatusClass(ach.status)">
                      {{ getStatusLabel(ach.status) }}
                    </span>
                  </td>
                  <td class="text-sm">{{ getDelayReasonLabels(ach.delayReasons) }}</td>
                  <td>
                    <div class="actions">
                      <button class="btn btn-sm btn-outline" (click)="openEditForm(ach)" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
                      <button class="btn btn-sm btn-outline btn-danger" (click)="deleteAchievement(ach.id)" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                    </div>
                  </td>
                </tr>
              }
              @if (allAchievements.length === 0) {
                <tr>
                  <td colspan="9" class="empty-state">
                    Ø±Ú©ÙˆØ±Ø¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <!-- ==================== FORM VIEW ==================== -->
  @if (showForm) {
    <!-- Back button -->
    <div class="page-header">
      <div>
        <h1 class="page-title">{{ editingAchievement ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ù…Ù„Ú©Ø±Ø¯' : 'Ø«Ø¨Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¬Ø¯ÛŒØ¯' }}</h1>
        <p class="page-subtitle">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
      </div>
      <button class="btn btn-outline" (click)="goBack()">
        â†’ Ø¨Ø§Ø²Ú¯Ø´Øª
      </button>
    </div>

    <form (ngSubmit)="handleSubmit()">
      <!-- Card 1: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ -->
      <div class="card form-card">
        <div class="card-header">
          <h3 class="card-title">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ</h3>
        </div>
        <div class="card-content">
          <div class="form-row">
            <div class="form-group">
              <label>Ù¾Ø±ÙˆÚ˜Ù‡</label>
              <select [(ngModel)]="formData.projectId" name="projectId" required>
                <option value="" disabled>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆÚ˜Ù‡</option>
                @for (p of dataService.projects; track p.id) {
                  <option [value]="p.id">{{ p.name }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Ø¨Ø±Ù†Ø§Ù…Ù‡</label>
              <select [(ngModel)]="formData.planId" name="planId" (ngModelChange)="onPlanChange()" required>
                <option value="" disabled>Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ù†Ø§Ù…Ù‡</option>
                @for (plan of filteredPlans; track plan.id) {
                  <option [value]="plan.id">{{ plan.title }}</option>
                }
              </select>
            </div>
          </div>

          @if (selectedPlan) {
            <div class="alert alert-info">
              <strong>Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡:</strong>
              {{ selectedPlan.title }} â€” Ù‡Ø¯Ù: {{ selectedPlan.targetAmount }} {{ getUnitLabel(selectedPlan.unit) }}
              ({{ selectedPlan.startDate }} ØªØ§ {{ selectedPlan.endDate }})
            </div>
          }

          <div class="form-row">
            <div class="form-group">
              <label>ØªØ§Ø±ÛŒØ®</label>
              <input type="text" [(ngModel)]="formData.date" name="date" placeholder="1403/08/15" required />
            </div>
            <div class="form-group">
              <label>Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø´Ø¯Ù‡</label>
              <input type="number" [(ngModel)]="formData.plannedAmount" name="plannedAmount" disabled />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Ù…Ù‚Ø¯Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯</label>
              <input type="number" [(ngModel)]="formData.achievedAmount" name="achievedAmount" required />
            </div>
            <div class="form-group">
              <label>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¨Ø§Ø²Ø¯Ù‡ÛŒ</label>
              <div class="efficiency-preview">
                <div class="efficiency-bar-wrapper">
                  <div
                    class="efficiency-bar"
                    [class.bar-high]="efficiencyPreview >= 100"
                    [class.bar-mid]="efficiencyPreview >= 50 && efficiencyPreview < 100"
                    [class.bar-low]="efficiencyPreview < 50"
                    [style.width.%]="Math.min(efficiencyPreview, 100)">
                  </div>
                </div>
                <span class="efficiency-label">{{ efficiencyPreview }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card 2: Ø¯Ù„Ø§ÛŒÙ„ Ø¹Ø¯Ù… ØªØ­Ù‚Ù‚ -->
      @if (showDelayReasons) {
        <div class="card form-card">
          <div class="card-header">
            <h3 class="card-title">Ø¯Ù„Ø§ÛŒÙ„ Ø¹Ø¯Ù… ØªØ­Ù‚Ù‚</h3>
          </div>
          <div class="card-content">
            <div class="checkbox-grid">
              @for (reason of staticDelayReasons; track reason.key) {
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="isDelayReasonSelected(reason.key)"
                    (change)="toggleDelayReason(reason.key)" />
                  {{ reason.label }}
                </label>
              }
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
              <textarea [(ngModel)]="formData.delayDescription" name="delayDescription" rows="3"
                        placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø¯Ù„Ø§ÛŒÙ„ Ø¹Ø¯Ù… ØªØ­Ù‚Ù‚"></textarea>
            </div>
          </div>
        </div>
      }

      <!-- Card 3: Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§ -->
      <div class="card form-card">
        <div class="card-header">
          <h3 class="card-title">Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§</h3>
        </div>
        <div class="card-content">
          @for (oh of formData.operatorHours; track trackByIndex($index); let i = $index) {
            <div class="dynamic-row">
              <div class="form-group flex-grow">
                <select [(ngModel)]="oh.operatorId" [name]="'operatorId_' + i">
                  <option value="" disabled>Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù¾Ø±Ø§ØªÙˆØ±</option>
                  @for (op of dataService.operators; track op.id) {
                    <option [value]="op.id">{{ op.name }}</option>
                  }
                </select>
              </div>
              <div class="form-group hours-input">
                <input type="number" [(ngModel)]="oh.hours" [name]="'operatorHours_' + i" placeholder="Ø³Ø§Ø¹Øª" />
              </div>
              <button type="button" class="btn btn-sm btn-outline btn-danger" (click)="removeOperatorHour(i)">âœ•</button>
            </div>
          }
          <button type="button" class="btn btn-outline btn-add" (click)="addOperatorHour()">
            â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù¾Ø±Ø§ØªÙˆØ±
          </button>
        </div>
      </div>

      <!-- Card 4: Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª -->
      <div class="card form-card">
        <div class="card-header">
          <h3 class="card-title">Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª</h3>
        </div>
        <div class="card-content">
          @for (eh of formData.equipmentHours; track trackByIndex($index); let i = $index) {
            <div class="dynamic-row">
              <div class="form-group flex-grow">
                <select [(ngModel)]="eh.equipmentId" [name]="'equipmentId_' + i">
                  <option value="" disabled>Ø§Ù†ØªØ®Ø§Ø¨ ØªØ¬Ù‡ÛŒØ²</option>
                  @for (eq of dataService.equipmentList; track eq.id) {
                    <option [value]="eq.id">{{ eq.name }}</option>
                  }
                </select>
              </div>
              <div class="form-group hours-input">
                <input type="number" [(ngModel)]="eh.hours" [name]="'equipmentHours_' + i" placeholder="Ø³Ø§Ø¹Øª" />
              </div>
              <button type="button" class="btn btn-sm btn-outline btn-danger" (click)="removeEquipmentHour(i)">âœ•</button>
            </div>
          }
          <button type="button" class="btn btn-outline btn-add" (click)="addEquipmentHour()">
            â• Ø§ÙØ²ÙˆØ¯Ù† ØªØ¬Ù‡ÛŒØ²
          </button>
        </div>
      </div>

      <!-- Card 5: ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ -->
      <div class="card form-card">
        <div class="card-header">
          <h3 class="card-title">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</h3>
        </div>
        <div class="card-content">
          <div class="form-group">
            <textarea [(ngModel)]="formData.notes" name="notes" rows="4"
                      placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ÛŒ"></textarea>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="form-actions">
        <button type="button" class="btn btn-outline" (click)="goBack()">Ø§Ù†ØµØ±Ø§Ù</button>
        <button type="submit" class="btn btn-primary">
          {{ editingAchievement ? 'ÙˆÛŒØ±Ø§ÛŒØ´' : 'Ø«Ø¨Øª Ø¹Ù…Ù„Ú©Ø±Ø¯' }}
        </button>
      </div>
    </form>
  }
</div>
