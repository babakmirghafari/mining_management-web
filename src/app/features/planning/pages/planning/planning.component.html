<div class="page" dir="rtl">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ 'feature.planning.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'feature.planning.title_desc' | translate }}</p>
    </div>
    <button class="btn btn-primary" (click)="openAddDialog()">
      â• Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¬Ø¯ÛŒØ¯
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">Ú©Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§</p>
          <p class="stat-value">{{ stats.total }}</p>
        </div>
        <span class="stat-icon">ğŸ“‹</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">ÙØ¹Ø§Ù„</p>
          <p class="stat-value text-green">{{ stats.active }}</p>
        </div>
        <span class="stat-icon">âœ…</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</p>
          <p class="stat-value text-blue">{{ stats.approved }}</p>
        </div>
        <span class="stat-icon">ğŸ“</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</p>
          <p class="stat-value text-gray">{{ stats.completed }}</p>
        </div>
        <span class="stat-icon">ğŸ</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    @for (pt of planTypes; track pt.value) {
      <button
        class="tab-btn"
        [class.tab-active]="activeTab === pt.value"
        (click)="setActiveTab(pt.value)">
        {{ pt.label }}
      </button>
    }
  </div>

  <!-- Plans Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ {{ getTypeLabel(activeTab) }}</h3>
    </div>
    <div class="card-content">
      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>Ø¹Ù†ÙˆØ§Ù† / ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
              <th>Ù¾Ø±ÙˆÚ˜Ù‡</th>
              <th>Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</th>
              <th>Ù‡Ø¯Ù / ÙˆØ§Ø­Ø¯</th>
              <th>Ø§ÙˆÙ„ÙˆÛŒØª</th>
              <th>ÙˆØ¶Ø¹ÛŒØª</th>
              <th>ØªØ¬Ù‡ÛŒØ²Ø§Øª</th>
              <th>Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody>
            @for (plan of filteredPlans; track plan.id) {
              <tr>
                <td>
                  <div class="cell-stack">
                    <span class="font-medium">{{ plan.title }}</span>
                    @if (plan.description) {
                      <span class="text-muted text-xs">{{ plan.description }}</span>
                    }
                  </div>
                </td>
                <td>{{ getProjectName(plan.projectId) }}</td>
                <td>
                  <div class="cell-stack">
                    <span class="text-sm">{{ plan.startDate }}</span>
                    <span class="text-muted text-xs">{{ plan.endDate }}</span>
                  </div>
                </td>
                <td>
                  <span class="font-medium">{{ plan.targetAmount }}</span>
                  <span class="text-muted text-sm"> {{ getUnitLabel(plan.unit) }}</span>
                </td>
                <td>
                  <span [class]="'badge ' + getPriorityInfo(plan.priority).color">
                    {{ getPriorityInfo(plan.priority).label }}
                  </span>
                </td>
                <td>
                  <div class="status-cell">
                    <span [class]="'badge ' + getStatusInfo(plan.status).color">
                      {{ getStatusInfo(plan.status).label }}
                    </span>
                    @if (getTransitionLabel(plan.status)) {
                      <button class="btn btn-sm btn-outline btn-transition" (click)="transitionStatus(plan)">
                        {{ getTransitionLabel(plan.status) }}
                      </button>
                    }
                  </div>
                </td>
                <td class="text-sm">{{ getEquipmentNames(plan.assignedEquipment) }}</td>
                <td class="text-sm">{{ getOperatorNames(plan.assignedOperators) }}</td>
                <td>
                  <div class="actions">
                    <button class="btn btn-sm btn-outline" (click)="openEditDialog(plan)" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
                    <button class="btn btn-sm btn-outline btn-danger" (click)="deletePlan(plan.id)" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                  </div>
                </td>
              </tr>
            }
            @if (filteredPlans.length === 0) {
              <tr>
                <td colspan="9" class="empty-state">
                  Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Dialog -->
  @if (isDialogOpen) {
    <div class="dialog-overlay" (click)="closeDialog()">
      <div class="dialog dialog-lg" (click)="$event.stopPropagation()" dir="rtl">
        <div class="dialog-header">
          <h3>{{ selectedPlan ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø±Ù†Ø§Ù…Ù‡' : 'Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¬Ø¯ÛŒØ¯' }}</h3>
          <p class="dialog-desc">
            {{ selectedPlan ? 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯' : 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯' }}
          </p>
        </div>
        <form (ngSubmit)="handleSubmit()" class="scrollable-form">
          <div class="form-row">
            <div class="form-group">
              <label>Ù¾Ø±ÙˆÚ˜Ù‡</label>
              <select [(ngModel)]="formData.projectId" name="projectId" required>
                <option value="" disabled>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆÚ˜Ù‡</option>
                @for (p of dataService.projects; track p.id) {
                  <option [value]="p.id">{{ p.name }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Ù†ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡</label>
              <select [(ngModel)]="formData.type" name="type">
                @for (t of planTypes; track t.value) {
                  <option [value]="t.value">{{ t.label }}</option>
                }
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" [(ngModel)]="formData.title" name="title" required />
          </div>
          <div class="form-group">
            <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
            <textarea [(ngModel)]="formData.description" name="description" rows="3"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
              <input type="text" [(ngModel)]="formData.startDate" name="startDate" placeholder="1403/08/15" required />
            </div>
            <div class="form-group">
              <label>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</label>
              <input type="text" [(ngModel)]="formData.endDate" name="endDate" placeholder="1403/08/15" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ù…Ù‚Ø¯Ø§Ø± Ù‡Ø¯Ù</label>
              <input type="number" [(ngModel)]="formData.targetAmount" name="targetAmount" required />
            </div>
            <div class="form-group">
              <label>ÙˆØ§Ø­Ø¯</label>
              <select [(ngModel)]="formData.unit" name="unit">
                @for (u of units; track u.value) {
                  <option [value]="u.value">{{ u.label }}</option>
                }
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ø§ÙˆÙ„ÙˆÛŒØª</label>
              <select [(ngModel)]="formData.priority" name="priority">
                @for (pr of priorities; track pr.value) {
                  <option [value]="pr.value">{{ pr.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>ÙˆØ¶Ø¹ÛŒØª</label>
              <select [(ngModel)]="formData.status" name="status">
                @for (s of statuses; track s.value) {
                  <option [value]="s.value">{{ s.label }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Equipment Checkboxes -->
          <div class="form-group">
            <label>ØªØ¬Ù‡ÛŒØ²Ø§Øª ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</label>
            <div class="checkbox-grid">
              @for (eq of dataService.equipmentList; track eq.id) {
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="isEquipmentSelected(eq.id)"
                    (change)="toggleEquipment(eq.id)" />
                  {{ eq.name }}
                </label>
              }
            </div>
          </div>

          <!-- Operator Checkboxes -->
          <div class="form-group">
            <label>Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§ÛŒ ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</label>
            <div class="checkbox-grid">
              @for (op of dataService.operators; track op.id) {
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="isOperatorSelected(op.id)"
                    (change)="toggleOperator(op.id)" />
                  {{ op.name }}
                </label>
              }
            </div>
          </div>

          <div class="dialog-actions">
            <button type="button" class="btn btn-outline" (click)="closeDialog()">Ø§Ù†ØµØ±Ø§Ù</button>
            <button type="submit" class="btn btn-primary">
              {{ selectedPlan ? 'ÙˆÛŒØ±Ø§ÛŒØ´' : 'Ø§ÙØ²ÙˆØ¯Ù†' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
