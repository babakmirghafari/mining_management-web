<div class="page" dir="rtl">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ 'feature.drill_planning.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'feature.drill_planning.title_desc' | translate }}</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">Ú©Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§</p>
          <p class="stat-value">{{ totalPlans }}</p>
        </div>
        <span class="stat-icon">ğŸ“‹</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</p>
          <p class="stat-value text-green">{{ activePlans }}</p>
        </div>
        <span class="stat-icon">ğŸ”„</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ØªØ­Ù‚Ù‚</p>
          <p class="stat-value text-blue">{{ avgAchievement }}%</p>
        </div>
        <span class="stat-icon">ğŸ“Š</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab" [class.tab-active]="activeTab === 'list'" (click)="switchTab('list')">
      Ù„ÛŒØ³Øª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§
    </button>
    <button class="tab" [class.tab-active]="activeTab === 'create'" (click)="switchTab('create')">
      Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡
    </button>
    <button class="tab" [class.tab-active]="activeTab === 'details'" [disabled]="!selectedPlan"
            (click)="switchTab('details')">
      Ø¬Ø²Ø¦ÛŒØ§Øª
    </button>
  </div>

  <!-- List Tab -->
  @if (activeTab === 'list') {
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Ù„ÛŒØ³Øª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø­ÙØ§Ø±ÛŒ</h3>
      </div>
      <div class="card-content">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>Ø¹Ù†ÙˆØ§Ù†</th>
                <th>Ù¾Ø±ÙˆÚ˜Ù‡</th>
                <th>Ø¯ÙˆØ±Ù‡</th>
                <th>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</th>
                <th>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</th>
                <th>Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡</th>
                <th>Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ù…Ù„Ú©Ø±Ø¯</th>
                <th>ØªØ­Ù‚Ù‚</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody>
              @for (plan of drillPlans; track plan.id) {
                <tr>
                  <td class="font-medium">{{ plan.title }}</td>
                  <td>{{ getProjectName(plan.projectId) }}</td>
                  <td>
                    <span class="badge" [class.badge-weekly]="plan.period === 'weekly'"
                          [class.badge-monthly]="plan.period === 'monthly'">
                      @if (plan.period === 'weekly') { Ù‡ÙØªÚ¯ÛŒ }
                      @if (plan.period === 'monthly') { Ù…Ø§Ù‡Ø§Ù†Ù‡ }
                    </span>
                  </td>
                  <td>{{ plan.startDate }}</td>
                  <td>{{ plan.endDate }}</td>
                  <td>{{ plan.totalPlanned }} {{ getUnitLabel(plan.unit) }}</td>
                  <td>{{ plan.totalActual }} {{ getUnitLabel(plan.unit) }}</td>
                  <td>
                    <span class="badge" [class]="getAchievementColor(plan.overallAchievement)">
                      {{ plan.overallAchievement }}%
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline" (click)="openDetails(plan)">
                      Ø¬Ø²Ø¦ÛŒØ§Øª
                    </button>
                  </td>
                </tr>
              }
              @if (drillPlans.length === 0) {
                <tr>
                  <td colspan="9" class="empty-state">
                    Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø­ÙØ§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <!-- Create Tab -->
  @if (activeTab === 'create') {
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø­ÙØ§Ø±ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
      </div>
      <div class="card-content">
        <form (ngSubmit)="handleCreate()" class="create-form">
          <!-- Project -->
          <div class="form-group">
            <label>Ù¾Ø±ÙˆÚ˜Ù‡</label>
            <select [(ngModel)]="formData.projectId" name="projectId" required>
              <option value="" disabled>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆÚ˜Ù‡</option>
              @for (p of dataService.projects; track p.id) {
                <option [value]="p.id">{{ p.name }}</option>
              }
            </select>
          </div>

          <!-- Period -->
          <div class="form-row">
            <div class="form-group">
              <label>Ø¯ÙˆØ±Ù‡</label>
              <select [(ngModel)]="formData.period" name="period">
                <option value="weekly">Ù‡ÙØªÚ¯ÛŒ</option>
                <option value="monthly">Ù…Ø§Ù‡Ø§Ù†Ù‡</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ø¹Ù†ÙˆØ§Ù†</label>
              <input type="text" [(ngModel)]="formData.title" name="title" required
                     placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø­ÙØ§Ø±ÛŒ" />
            </div>
          </div>

          <!-- Start date & Unit -->
          <div class="form-row">
            <div class="form-group">
              <label>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
              <input type="text" [(ngModel)]="formData.startDate" name="startDate"
                     placeholder="1403/08/15" required />
            </div>
            <div class="form-group">
              <label>ÙˆØ§Ø­Ø¯</label>
              <select [(ngModel)]="formData.unit" name="unit">
                @for (u of unitOptions; track u.value) {
                  <option [value]="u.value">{{ u.label }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Daily target -->
          <div class="form-group">
            <label>Ù‡Ø¯Ù Ø±ÙˆØ²Ø§Ù†Ù‡</label>
            <input type="number" [(ngModel)]="formData.dailyTarget" name="dailyTarget" required />
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-outline" (click)="switchTab('list')">Ø§Ù†ØµØ±Ø§Ù</button>
            <button type="submit" class="btn btn-primary">Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Details Tab -->
  @if (activeTab === 'details' && selectedPlan) {
    <div class="card">
      <div class="card-header details-header">
        <div>
          <h3 class="card-title">{{ selectedPlan.title }}</h3>
          <p class="text-muted text-sm">
            Ù¾Ø±ÙˆÚ˜Ù‡: {{ getProjectName(selectedPlan.projectId) }} |
            Ø¯ÙˆØ±Ù‡: @if (selectedPlan.period === 'weekly') { Ù‡ÙØªÚ¯ÛŒ } @else { Ù…Ø§Ù‡Ø§Ù†Ù‡ } |
            {{ selectedPlan.startDate }} - {{ selectedPlan.endDate }}
          </p>
        </div>
        <button class="btn btn-primary" (click)="saveDetails()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
      </div>
      <div class="card-content">
        <!-- Summary Stats -->
        <div class="details-stats">
          <div class="detail-stat">
            <span class="detail-stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡</span>
            <span class="detail-stat-value">{{ selectedPlan.totalPlanned }} {{ getUnitLabel(selectedPlan.unit) }}</span>
          </div>
          <div class="detail-stat">
            <span class="detail-stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ù…Ù„Ú©Ø±Ø¯</span>
            <span class="detail-stat-value">{{ selectedPlan.totalActual }} {{ getUnitLabel(selectedPlan.unit) }}</span>
          </div>
          <div class="detail-stat">
            <span class="detail-stat-label">ØªØ­Ù‚Ù‚ Ú©Ù„ÛŒ</span>
            <span class="detail-stat-value" [class]="getAchievementColor(selectedPlan.overallAchievement)">
              {{ selectedPlan.overallAchievement }}%
            </span>
          </div>
        </div>

        <!-- Daily Editable Table -->
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>ØªØ§Ø±ÛŒØ®</th>
                <th>Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡</th>
                <th>Ù…Ù‚Ø¯Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯</th>
                <th>ØªØ­Ù‚Ù‚ (%)</th>
                <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
              </tr>
            </thead>
            <tbody>
              @for (day of selectedPlan.days; track day.date) {
                <tr>
                  <td>{{ day.date }}</td>
                  <td>
                    <input type="number" class="inline-input" [(ngModel)]="day.plannedAmount"
                           (ngModelChange)="recalculateDayAchievement(day)" />
                  </td>
                  <td>
                    <input type="number" class="inline-input" [(ngModel)]="day.actualAmount"
                           (ngModelChange)="recalculateDayAchievement(day)" />
                  </td>
                  <td>
                    <span class="badge" [class]="getAchievementColor(day.achievementPercentage)">
                      {{ day.achievementPercentage }}%
                    </span>
                  </td>
                  <td>
                    <input type="text" class="inline-input inline-input-wide" [(ngModel)]="day.notes"
                           placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª..." />
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }
</div>
