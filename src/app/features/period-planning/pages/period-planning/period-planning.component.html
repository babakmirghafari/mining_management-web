<div class="page" dir="rtl">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ 'feature.period_planning.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'feature.period_planning.title_desc' | translate }}</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateDialog()">
      â• Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø¬Ø¯ÛŒØ¯
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">Ú©Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§</p>
          <p class="stat-value">{{ stats.total }}</p>
        </div>
        <span class="stat-icon">ğŸ“‹</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</p>
          <p class="stat-value text-gray">{{ stats.draft }}</p>
        </div>
        <span class="stat-icon">ğŸ“</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</p>
          <p class="stat-value text-blue">{{ stats.approved }}</p>
        </div>
        <span class="stat-icon">âœ…</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">ÙØ¹Ø§Ù„</p>
          <p class="stat-value text-green">{{ stats.active }}</p>
        </div>
        <span class="stat-icon">ğŸ”„</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</p>
          <p class="stat-value text-completed">{{ stats.completed }}</p>
        </div>
        <span class="stat-icon">ğŸ</span>
      </div>
    </div>
  </div>

  <!-- Plans Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Ù„ÛŒØ³Øª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ</h3>
    </div>
    <div class="card-content">
      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>Ø¹Ù†ÙˆØ§Ù† / ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
              <th>Ù¾Ø±ÙˆÚ˜Ù‡</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
              <th>Ø¯ÙˆØ±Ù‡ / Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</th>
              <th>Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ / ÙˆØ§Ø­Ø¯</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody>
            @for (plan of allPeriodPlans; track plan.id) {
              <tr>
                <td>
                  <div class="cell-stack">
                    <span class="font-medium">{{ plan.title }}</span>
                    @if (plan.description) {
                      <span class="text-muted text-xs">{{ plan.description }}</span>
                    }
                  </div>
                </td>
                <td>{{ getProjectName(plan.projectId) }}</td>
                <td>
                  <span class="badge status-blue">{{ plan.operationName || getOperationName(plan.operationId) }}</span>
                </td>
                <td>
                  <div class="cell-stack">
                    <span class="badge period-badge">{{ getPeriodLabel(plan.period) }}</span>
                    <span class="text-muted text-xs">{{ plan.startDate }} - {{ plan.endDate }}</span>
                  </div>
                </td>
                <td>
                  <span class="font-medium">{{ plan.totalPlanned }}</span>
                  <span class="text-muted text-sm"> {{ getUnitLabel(plan.unit) }}</span>
                </td>
                <td>
                  <div class="actions">
                    <button class="btn btn-sm btn-outline" (click)="openViewDialog(plan)" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡">ğŸ‘ï¸</button>
                    <button class="btn btn-sm btn-outline btn-danger" (click)="deletePlan(plan.id)" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                  </div>
                </td>
              </tr>
            }
            @if (allPeriodPlans.length === 0) {
              <tr>
                <td colspan="6" class="empty-state">
                  Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Create Dialog -->
  @if (isCreateDialogOpen) {
    <div class="dialog-overlay" (click)="closeCreateDialog()">
      <div class="dialog dialog-lg" (click)="$event.stopPropagation()" dir="rtl">
        <div class="dialog-header">
          <h3>Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
          <p class="dialog-desc">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
        </div>
        <form (ngSubmit)="handleCreate()" class="scrollable-form">
          <!-- Project & Operation -->
          <div class="form-row">
            <div class="form-group">
              <label>Ù¾Ø±ÙˆÚ˜Ù‡</label>
              <select [(ngModel)]="formData.projectId" name="projectId" required (ngModelChange)="onProjectChange()">
                <option value="" disabled>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆÚ˜Ù‡</option>
                @for (p of dataService.projects; track p.id) {
                  <option [value]="p.id">{{ p.name }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Ø¹Ù…Ù„ÛŒØ§Øª</label>
              <select [(ngModel)]="formData.operationId" name="operationId" required>
                <option value="" disabled>Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ù…Ù„ÛŒØ§Øª</option>
                @for (op of filteredOperations; track op.id) {
                  <option [value]="op.id">{{ op.name }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Title -->
          <div class="form-group">
            <label>Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" [(ngModel)]="formData.title" name="title" required />
          </div>

          <!-- Description -->
          <div class="form-group">
            <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
            <textarea [(ngModel)]="formData.description" name="description" rows="3"></textarea>
          </div>

          <!-- Period & Start Date -->
          <div class="form-row">
            <div class="form-group">
              <label>Ù†ÙˆØ¹ Ø¯ÙˆØ±Ù‡</label>
              <select [(ngModel)]="formData.period" name="period">
                @for (po of periodOptions; track po.value) {
                  <option [value]="po.value">{{ po.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
              <input type="text" [(ngModel)]="formData.startDate" name="startDate" placeholder="1403/08/15" required />
            </div>
          </div>

          <!-- Custom End Date -->
          @if (isCustomPeriod) {
            <div class="form-group">
              <label>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø³ÙØ§Ø±Ø´ÛŒ</label>
              <input type="text" [(ngModel)]="formData.customEndDate" name="customEndDate" placeholder="1403/09/15" required />
            </div>
          }

          <!-- Unit & Default Daily Target -->
          <div class="form-row">
            <div class="form-group">
              <label>ÙˆØ§Ø­Ø¯</label>
              <select [(ngModel)]="formData.unit" name="unit">
                @for (u of units; track u.value) {
                  <option [value]="u.value">{{ u.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Ù‡Ø¯Ù Ø±ÙˆØ²Ø§Ù†Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶</label>
              <input type="number" [(ngModel)]="formData.defaultDailyTarget" name="defaultDailyTarget" required />
            </div>
          </div>

          <!-- Equipment Checkboxes -->
          @if (filteredEquipment.length > 0) {
            <div class="form-group">
              <label>ØªØ¬Ù‡ÛŒØ²Ø§Øª</label>
              <div class="checkbox-grid">
                @for (eq of filteredEquipment; track eq.id) {
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      [checked]="isEquipmentSelected(eq.id)"
                      (change)="toggleEquipment(eq.id)" />
                    {{ eq.name }}
                  </label>
                }
              </div>
            </div>
          }

          <!-- Operator Checkboxes -->
          @if (filteredOperators.length > 0) {
            <div class="form-group">
              <label>Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§</label>
              <div class="checkbox-grid">
                @for (op of filteredOperators; track op.id) {
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      [checked]="isOperatorSelected(op.id)"
                      (change)="toggleOperator(op.id)" />
                    {{ op.name }}
                  </label>
                }
              </div>
            </div>
          }

          <div class="dialog-actions">
            <button type="button" class="btn btn-outline" (click)="closeCreateDialog()">Ø§Ù†ØµØ±Ø§Ù</button>
            <button type="submit" class="btn btn-primary">Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- View Dialog -->
  @if (isViewDialogOpen && viewPlan) {
    <div class="dialog-overlay" (click)="closeViewDialog()">
      <div class="dialog dialog-xl" (click)="$event.stopPropagation()" dir="rtl">
        <div class="dialog-header">
          <h3>Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ</h3>
          <p class="dialog-desc">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡</p>
        </div>
        <div class="scrollable-form">
          <!-- Header grid -->
          <div class="view-grid">
            <div class="view-item">
              <span class="view-label">Ø¹Ù†ÙˆØ§Ù†</span>
              <span class="view-value">{{ viewPlan.title }}</span>
            </div>
            <div class="view-item">
              <span class="view-label">Ù¾Ø±ÙˆÚ˜Ù‡</span>
              <span class="view-value">{{ getProjectName(viewPlan.projectId) }}</span>
            </div>
            <div class="view-item">
              <span class="view-label">Ø¹Ù…Ù„ÛŒØ§Øª</span>
              <span class="view-value">{{ viewPlan.operationName || getOperationName(viewPlan.operationId) }}</span>
            </div>
            <div class="view-item">
              <span class="view-label">Ø¯ÙˆØ±Ù‡</span>
              <span class="view-value">{{ getPeriodLabel(viewPlan.period) }}</span>
            </div>
            <div class="view-item">
              <span class="view-label">ÙˆØ§Ø­Ø¯</span>
              <span class="view-value">{{ getUnitLabel(viewPlan.unit) }}</span>
            </div>
            <div class="view-item">
              <span class="view-label">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</span>
              <span class="view-value">{{ viewPlan.startDate }}</span>
            </div>
            <div class="view-item">
              <span class="view-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</span>
              <span class="view-value">{{ viewPlan.endDate }}</span>
            </div>
            @if (viewPlan.description) {
              <div class="view-item view-item-full">
                <span class="view-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</span>
                <span class="view-value">{{ viewPlan.description }}</span>
              </div>
            }
          </div>

          <!-- Total planned summary -->
          <div class="total-summary">
            <span class="total-label">Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø´Ø¯Ù‡:</span>
            <span class="total-value">{{ viewPlan.totalPlanned }} {{ getUnitLabel(viewPlan.unit) }}</span>
          </div>

          <!-- Daily plans table -->
          <div class="card inner-card">
            <div class="card-header">
              <h3 class="card-title">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡</h3>
            </div>
            <div class="card-content">
              <div class="table-wrapper">
                <table class="table">
                  <thead>
                    <tr>
                      <th>ØªØ§Ø±ÛŒØ®</th>
                      <th>Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡</th>
                      <th>ÙˆØ¶Ø¹ÛŒØª</th>
                      <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (day of viewPlan.days; track day.date) {
                      <tr [class.holiday-row]="day.isHoliday">
                        <td>{{ day.date }}</td>
                        <td>
                          <span [class]="getDayAmountColor(day.plannedAmount)">{{ day.plannedAmount }}</span>
                        </td>
                        <td>
                          @if (day.isHoliday) {
                            <span class="badge badge-holiday">ØªØ¹Ø·ÛŒÙ„</span>
                          } @else {
                            <span class="badge badge-working">Ú©Ø§Ø±ÛŒ</span>
                          }
                        </td>
                        <td class="text-muted text-sm">{{ day.notes || '-' }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Equipment badges -->
          @if (viewPlan.assignedEquipment && viewPlan.assignedEquipment.length > 0) {
            <div class="badges-section">
              <h4 class="badges-title">ØªØ¬Ù‡ÛŒØ²Ø§Øª ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</h4>
              <div class="badges-list">
                @for (eqId of viewPlan.assignedEquipment; track eqId) {
                  <span class="badge badge-equipment">{{ getEquipmentName(eqId) }}</span>
                }
              </div>
            </div>
          }

          <!-- Operator badges -->
          @if (viewPlan.assignedOperators && viewPlan.assignedOperators.length > 0) {
            <div class="badges-section">
              <h4 class="badges-title">Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§ÛŒ ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</h4>
              <div class="badges-list">
                @for (opId of viewPlan.assignedOperators; track opId) {
                  <span class="badge badge-operator">{{ getOperatorName(opId) }}</span>
                }
              </div>
            </div>
          }

          <div class="dialog-actions">
            <button type="button" class="btn btn-outline" (click)="closeViewDialog()">Ø¨Ø³ØªÙ†</button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
