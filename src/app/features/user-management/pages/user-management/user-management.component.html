<div class="page" dir="rtl">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">
        {{ currentUser?.role === 'admin' ? 'Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†' : 'Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§' }}
      </h1>
      <p class="page-subtitle">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø³ÛŒØ³ØªÙ… Ùˆ ØªØ®ØµÛŒØµ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</p>
    </div>
    <button class="btn btn-primary" (click)="openAddDialog()">
      â• Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
    </button>
  </div>

  <!-- Users Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
    </div>
    <div class="card-content">
      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>Ù†Ø§Ù…</th>
              <th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
              <th>Ù†Ù‚Ø´</th>
              <th>Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</th>
              <th>ØªÙ„ÙÙ†</th>
              <th>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody>
            @for (user of filteredUsers; track user.id) {
              <tr>
                <td>{{ user.name }}</td>
                <td class="font-mono">{{ user.username }}</td>
                <td>
                  <span [class]="'badge ' + getRoleBadgeClass(user.role)">
                    {{ getRoleLabel(user.role) }}
                  </span>
                </td>
                <td class="text-sm">{{ getProjectNames(user.assignedProjects) }}</td>
                <td class="font-mono text-sm">{{ user.phone || '-' }}</td>
                <td>{{ user.createdAt }}</td>
                <td>
                  <div class="actions">
                    @if (canManageRole(user.role)) {
                      <button class="btn btn-sm btn-outline" (click)="openEditDialog(user)" title="ÙˆÛŒØ±Ø§ÛŒØ´">
                        âœï¸
                      </button>
                      @if (user.id !== currentUser?.id) {
                        <button class="btn btn-sm btn-outline btn-danger" (click)="deleteUser(user.id)" title="Ø­Ø°Ù">
                          ğŸ—‘ï¸
                        </button>
                      }
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Dialog -->
  @if (isDialogOpen) {
    <div class="dialog-overlay" (click)="closeDialog()">
      <div class="dialog" (click)="$event.stopPropagation()" dir="rtl">
        <div class="dialog-header">
          <h3>{{ selectedUser ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±' : 'Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯' }}</h3>
          <p class="dialog-desc">
            {{ selectedUser ? 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯' : 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯' }}
          </p>
        </div>
        <form (ngSubmit)="handleSubmit()">
          <div class="form-group">
            <label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
            <input type="text" [(ngModel)]="formData.name" name="name" required />
          </div>
          <div class="form-group">
            <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
            <input type="text" [(ngModel)]="formData.username" name="username" required dir="ltr" />
          </div>
          <div class="form-group">
            <label>Ù†Ù‚Ø´</label>
            <select [(ngModel)]="formData.role" name="role">
              @for (role of getAvailableRoles(); track role.value) {
                <option [value]="role.value">{{ role.label }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</label>
            <input type="text" [(ngModel)]="formData.phone" name="phone" dir="ltr" />
          </div>
          <div class="form-group">
            <label>Ø§ÛŒÙ…ÛŒÙ„</label>
            <input type="email" [(ngModel)]="formData.email" name="email" dir="ltr" />
          </div>

          @if (formData.role === 'project_manager' || formData.role === 'operator') {
            <div class="form-group">
              <label>Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</label>
              <div class="checkbox-list">
                @for (project of dataService.projects; track project.id) {
                  <label class="checkbox-item">
                    <input
                      type="checkbox"
                      [checked]="isProjectAssigned(project.id)"
                      (change)="toggleProject(project.id)"
                    />
                    <span>{{ project.name }}</span>
                  </label>
                }
              </div>
            </div>
          }

          <div class="dialog-actions">
            <button type="button" class="btn btn-outline" (click)="closeDialog()">Ø§Ù†ØµØ±Ø§Ù</button>
            <button type="submit" class="btn btn-primary">
              {{ selectedUser ? 'ÙˆÛŒØ±Ø§ÛŒØ´' : 'Ø§ÙØ²ÙˆØ¯Ù†' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
