<div class="page" dir="rtl">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ 'feature.daily_planning.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'feature.daily_planning.title_desc' | translate }}</p>
    </div>
  </div>

  <!-- Plan selector (if multiple plans) -->
  @if (periodPlans.length > 1) {
    <div class="plan-selector">
      <label>Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ù†Ø§Ù…Ù‡:</label>
      <select [(ngModel)]="selectedPlanId">
        @for (plan of periodPlans; track plan.id) {
          <option [value]="plan.id">{{ plan.title }} - {{ plan.operationName }} ({{ plan.startDate }} ØªØ§ {{ plan.endDate }})</option>
        }
      </select>
    </div>
  }

  @if (periodPlans.length === 0) {
    <div class="card">
      <div class="card-content empty-state-box">
        <p class="empty-state">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø±ÙˆØ²Ø§Ù†Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ø§Ø¨ØªØ¯Ø§ Ø§Ø² Ø¨Ø®Ø´ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒØŒ ÛŒÚ© Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯.</p>
      </div>
    </div>
  }

  <!-- All plans as expandable cards -->
  @for (plan of periodPlans; track plan.id) {
    <div class="plan-card" [class.plan-card-expanded]="isExpanded(plan.id)">
      <!-- Plan card header (clickable to expand/collapse) -->
      <div class="plan-card-header" (click)="toggleExpand(plan.id)">
        <div class="plan-card-title-row">
          <span class="expand-icon">{{ isExpanded(plan.id) ? 'â–¼' : 'â—€' }}</span>
          <div>
            <h3 class="plan-card-title">{{ plan.title }}</h3>
            <p class="plan-card-subtitle">
              {{ plan.operationName }} | {{ getProjectName(plan.projectId) }} | {{ plan.startDate }} ØªØ§ {{ plan.endDate }}
            </p>
          </div>
        </div>
        <div class="plan-card-quick-stats">
          <span class="quick-stat">{{ getTotalPlanned(plan) }} {{ getUnitLabel(plan.unit) }}</span>
          <span class="quick-stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡</span>
        </div>
      </div>

      @if (isExpanded(plan.id)) {
        <!-- Stats row (5 stats) -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-card-body">
              <div>
                <p class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ</p>
                <p class="stat-value">{{ getTotalPlanned(plan) }}</p>
              </div>
              <span class="stat-icon">ğŸ“Š</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-card-body">
              <div>
                <p class="stat-label">Ú©Ù„ Ø±ÙˆØ²Ù‡Ø§</p>
                <p class="stat-value">{{ getTotalDays(plan) }}</p>
              </div>
              <span class="stat-icon">ğŸ“…</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-card-body">
              <div>
                <p class="stat-label">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ</p>
                <p class="stat-value text-green">{{ getWorkingDays(plan) }}</p>
              </div>
              <span class="stat-icon">ğŸ”¨</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-card-body">
              <div>
                <p class="stat-label">Ø±ÙˆØ²Ù‡Ø§ÛŒ ØªØ¹Ø·ÛŒÙ„</p>
                <p class="stat-value text-red">{{ getHolidayDays(plan) }}</p>
              </div>
              <span class="stat-icon">ğŸ–ï¸</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-card-body">
              <div>
                <p class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡</p>
                <p class="stat-value text-blue">{{ getAverageDailyPlan(plan) }}</p>
              </div>
              <span class="stat-icon">ğŸ“ˆ</span>
            </div>
          </div>
        </div>

        <!-- Period info card -->
        <div class="period-info-card">
          <div class="period-info-grid">
            <div class="period-info-item">
              <span class="period-info-label">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</span>
              <span class="period-info-value">{{ plan.startDate }}</span>
            </div>
            <div class="period-info-item">
              <span class="period-info-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</span>
              <span class="period-info-value">{{ plan.endDate }}</span>
            </div>
            <div class="period-info-item">
              <span class="period-info-label">ÙˆØ§Ø­Ø¯</span>
              <span class="period-info-value">{{ getUnitLabel(plan.unit) }}</span>
            </div>
          </div>
          <div class="period-info-actions">
            <button class="btn btn-outline btn-friday" (click)="markFridaysAsHoliday(plan)">
              ğŸ—“ï¸ Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¬Ù…Ø¹Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ØªØ¹Ø·ÛŒÙ„
            </button>
          </div>
        </div>

        <!-- Daily table -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡</h3>
          </div>
          <div class="card-content">
            <div class="table-wrapper">
              <table class="table">
                <thead>
                  <tr>
                    <th>Ø±Ø¯ÛŒÙ</th>
                    <th>ØªØ§Ø±ÛŒØ®</th>
                    <th>Ø±ÙˆØ² Ù‡ÙØªÙ‡</th>
                    <th>Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ ({{ getUnitLabel(plan.unit) }})</th>
                    <th>ØªØ¹Ø·ÛŒÙ„</th>
                    <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
                  </tr>
                </thead>
                <tbody>
                  @for (day of plan.days; track day.date; let i = $index) {
                    <tr [class.holiday-row]="day.isHoliday">
                      <td class="text-muted">{{ i + 1 }}</td>
                      <td class="font-medium">{{ day.date }}</td>
                      <td>
                        <span class="day-name" [class.day-friday]="getPersianDayOfWeek(day.date) === 'Ø¬Ù…Ø¹Ù‡'">
                          {{ getPersianDayOfWeek(day.date) }}
                        </span>
                      </td>
                      <td>
                        <input
                          type="number"
                          class="inline-input"
                          [(ngModel)]="day.plannedAmount"
                          [disabled]="day.isHoliday === true"
                          min="0" />
                      </td>
                      <td>
                        <label class="checkbox-label-inline">
                          <input
                            type="checkbox"
                            [checked]="day.isHoliday"
                            (change)="toggleHoliday(day)" />
                          @if (day.isHoliday) {
                            <span class="badge badge-holiday">ØªØ¹Ø·ÛŒÙ„</span>
                          } @else {
                            <span class="badge badge-working">Ú©Ø§Ø±ÛŒ</span>
                          }
                        </label>
                      </td>
                      <td>
                        <textarea
                          class="inline-textarea"
                          [(ngModel)]="day.notes"
                          [disabled]="day.isHoliday === true"
                          placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª..."
                          rows="1"></textarea>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Equipment badges -->
        @if (plan.assignedEquipment && plan.assignedEquipment.length > 0) {
          <div class="badges-section">
            <h4 class="badges-title">ØªØ¬Ù‡ÛŒØ²Ø§Øª ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</h4>
            <div class="badges-list">
              @for (eqId of plan.assignedEquipment; track eqId) {
                <span class="badge badge-equipment">{{ getEquipmentName(eqId) }}</span>
              }
            </div>
          </div>
        }

        <!-- Operator badges -->
        @if (plan.assignedOperators && plan.assignedOperators.length > 0) {
          <div class="badges-section">
            <h4 class="badges-title">Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§ÛŒ ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</h4>
            <div class="badges-list">
              @for (opId of plan.assignedOperators; track opId) {
                <span class="badge badge-operator">{{ getOperatorName(opId) }}</span>
              }
            </div>
          </div>
        }

        <!-- Save button -->
        <div class="save-actions">
          <button class="btn btn-primary btn-save" (click)="savePlan(plan)">
            ğŸ’¾ {{ 'common.save' | translate }}
          </button>
        </div>
      }
    </div>
  }
</div>
