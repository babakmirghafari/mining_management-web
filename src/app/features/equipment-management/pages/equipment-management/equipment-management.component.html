<div class="page" dir="rtl">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¬Ù‡ÛŒØ²Ø§Øª</h1>
      <p class="page-subtitle">Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ø´ÛŒÙ†â€ŒØ¢Ù„Ø§Øª Ùˆ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ù…Ø¹Ø¯Ù†</p>
    </div>
    @if (currentUser?.role === 'admin') {
      <button class="btn btn-primary" (click)="openAddDialog()">
        â• ØªØ¬Ù‡ÛŒØ² Ø¬Ø¯ÛŒØ¯
      </button>
    }
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">Ú©Ù„ ØªØ¬Ù‡ÛŒØ²Ø§Øª</p>
          <p class="stat-value">{{ stats.total }}</p>
        </div>
        <span class="stat-icon">ğŸš›</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">ÙØ¹Ø§Ù„</p>
          <p class="stat-value text-green">{{ stats.active }}</p>
        </div>
        <span class="stat-icon">âœ…</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">Ø¯Ø± ØªØ¹Ù…ÛŒØ±</p>
          <p class="stat-value text-yellow">{{ stats.maintenance }}</p>
        </div>
        <span class="stat-icon">ğŸ”§</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card-body">
        <div>
          <p class="stat-label">Ø®Ø§Ø±Ø¬ Ø§Ø² Ø³Ø±ÙˆÛŒØ³</p>
          <p class="stat-value text-red">{{ stats.outOfService }}</p>
        </div>
        <span class="stat-icon">âš ï¸</span>
      </div>
    </div>
  </div>

  <!-- Equipment Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Ù„ÛŒØ³Øª ØªØ¬Ù‡ÛŒØ²Ø§Øª</h3>
    </div>
    <div class="card-content">
      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>Ù†Ø§Ù… / Ú©Ø¯</th>
              <th>Ù†ÙˆØ¹</th>
              <th>Ù…Ø¯Ù„</th>
              <th>ÙˆØ¶Ø¹ÛŒØª</th>
              <th>Ù¾Ø±ÙˆÚ˜Ù‡</th>
              <th>Ù…ÙˆÙ‚Ø¹ÛŒØª</th>
              <th>Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ú©Ø±Ø¯</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody>
            @for (eq of filteredEquipment; track eq.id) {
              <tr>
                <td>
                  <div class="cell-stack">
                    <span class="font-medium">{{ eq.name }}</span>
                    <span class="text-muted text-xs">{{ eq.code }}</span>
                  </div>
                </td>
                <td>
                  <span class="badge badge-outline">{{ getTypeLabel(eq.type) }}</span>
                </td>
                <td>
                  <div class="cell-stack">
                    <span class="text-sm font-medium">{{ eq.model }}</span>
                    <span class="text-muted text-xs">{{ eq.manufacturer }}</span>
                  </div>
                </td>
                <td>
                  <span [class]="'badge ' + getStatusInfo(eq.status).color">
                    {{ getStatusInfo(eq.status).label }}
                  </span>
                </td>
                <td>{{ getProjectName(eq.assignedProject) }}</td>
                <td class="text-sm">{{ eq.location }}</td>
                <td class="text-sm">{{ eq.operationHours.toLocaleString() }} Ø³Ø§Ø¹Øª</td>
                <td>
                  <div class="actions-wrap">
                    @if (currentUser?.role === 'admin') {
                      <div class="actions">
                        <button class="btn btn-sm btn-outline" (click)="openEditDialog(eq)" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœï¸</button>
                        <button class="btn btn-sm btn-outline" (click)="openTransferDialog(eq)" title="Ø§Ù†ØªÙ‚Ø§Ù„">ğŸ”„</button>
                        <button class="btn btn-sm btn-outline btn-danger" (click)="deleteEquipment(eq.id)" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                      </div>
                    }
                    <div class="actions">
                      @if (eq.status !== 'maintenance') {
                        <button class="btn btn-sm btn-outline" (click)="handleStatusChange(eq.id, 'maintenance')" title="Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªØ¹Ù…ÛŒØ±">ğŸ”§</button>
                      }
                      @if (eq.status === 'maintenance') {
                        <button class="btn btn-sm btn-outline" (click)="handleStatusChange(eq.id, 'active')" title="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø¯Ù…Øª">
                          <span class="dot-green"></span>
                        </button>
                      }
                      @if (eq.status !== 'out_of_service') {
                        <button class="btn btn-sm btn-outline" (click)="handleStatusChange(eq.id, 'out_of_service')" title="Ø®Ø§Ø±Ø¬ Ø§Ø² Ø³Ø±ÙˆÛŒØ³">âš ï¸</button>
                      }
                    </div>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Dialog -->
  @if (isDialogOpen) {
    <div class="dialog-overlay" (click)="closeDialog()">
      <div class="dialog dialog-lg" (click)="$event.stopPropagation()" dir="rtl">
        <div class="dialog-header">
          <h3>{{ selectedEquipment ? 'ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¬Ù‡ÛŒØ²' : 'Ø§ÙØ²ÙˆØ¯Ù† ØªØ¬Ù‡ÛŒØ² Ø¬Ø¯ÛŒØ¯' }}</h3>
          <p class="dialog-desc">
            {{ selectedEquipment ? 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ¬Ù‡ÛŒØ² Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯' : 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ¬Ù‡ÛŒØ² Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯' }}
          </p>
        </div>
        <form (ngSubmit)="handleSubmit()" class="scrollable-form">
          <div class="form-row">
            <div class="form-group">
              <label>Ù†Ø§Ù… ØªØ¬Ù‡ÛŒØ²</label>
              <input type="text" [(ngModel)]="formData.name" name="name" required />
            </div>
            <div class="form-group">
              <label>Ú©Ø¯ ØªØ¬Ù‡ÛŒØ²</label>
              <input type="text" [(ngModel)]="formData.code" name="code" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ù†ÙˆØ¹ ØªØ¬Ù‡ÛŒØ²</label>
              <select [(ngModel)]="formData.type" name="type">
                @for (t of equipmentTypes; track t.value) {
                  <option [value]="t.value">{{ t.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Ù…Ø¯Ù„</label>
              <input type="text" [(ngModel)]="formData.model" name="model" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ø³Ø§Ø²Ù†Ø¯Ù‡</label>
              <input type="text" [(ngModel)]="formData.manufacturer" name="manufacturer" required />
            </div>
            <div class="form-group">
              <label>Ø³Ø§Ù„ Ø®Ø±ÛŒØ¯</label>
              <input type="text" [(ngModel)]="formData.yearOfPurchase" name="yearOfPurchase" placeholder="1400" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ÙˆØ¶Ø¹ÛŒØª</label>
              <select [(ngModel)]="formData.status" name="status">
                @for (s of equipmentStatuses; track s.value) {
                  <option [value]="s.value">{{ s.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Ù¾Ø±ÙˆÚ˜Ù‡ ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</label>
              <select [(ngModel)]="formData.assignedProject" name="assignedProject">
                <option value="">Ø¨Ø¯ÙˆÙ† Ù¾Ø±ÙˆÚ˜Ù‡</option>
                @for (p of dataService.projects; track p.id) {
                  <option [value]="p.id">{{ p.name }}</option>
                }
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
            <input type="text" [(ngModel)]="formData.location" name="location" required />
          </div>
          <div class="form-row form-row-3">
            <div class="form-group">
              <label>Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ú©Ø±Ø¯</label>
              <input type="number" [(ngModel)]="formData.operationHours" name="operationHours" />
            </div>
            <div class="form-group">
              <label>Ø¢Ø®Ø±ÛŒÙ† ØªØ¹Ù…ÛŒØ±</label>
              <input type="text" [(ngModel)]="formData.lastMaintenance" name="lastMaintenance" placeholder="1403/08/15" />
            </div>
            <div class="form-group">
              <label>ØªØ¹Ù…ÛŒØ± Ø¨Ø¹Ø¯ÛŒ</label>
              <input type="text" [(ngModel)]="formData.nextMaintenance" name="nextMaintenance" placeholder="1403/10/15" />
            </div>
          </div>
          <div class="form-group">
            <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
            <textarea [(ngModel)]="formData.description" name="description" rows="3"></textarea>
          </div>
          <div class="dialog-actions">
            <button type="button" class="btn btn-outline" (click)="closeDialog()">Ø§Ù†ØµØ±Ø§Ù</button>
            <button type="submit" class="btn btn-primary">
              {{ selectedEquipment ? 'ÙˆÛŒØ±Ø§ÛŒØ´' : 'Ø§ÙØ²ÙˆØ¯Ù†' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Transfer Dialog -->
  @if (isTransferDialogOpen) {
    <div class="dialog-overlay" (click)="closeTransferDialog()">
      <div class="dialog" (click)="$event.stopPropagation()" dir="rtl">
        <div class="dialog-header">
          <h3>Ø§Ù†ØªÙ‚Ø§Ù„ ØªØ¬Ù‡ÛŒØ²</h3>
          <p class="dialog-desc">Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ù‚ØµØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ ØªØ¬Ù‡ÛŒØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
        </div>
        <div class="transfer-body">
          <p>Ø§Ù†ØªÙ‚Ø§Ù„ ØªØ¬Ù‡ÛŒØ² "{{ transferEquipment?.name }}" Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯:</p>
          <div class="form-group">
            <select [(ngModel)]="newProjectId" name="newProjectId">
              <option value="" disabled>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ù‚ØµØ¯</option>
              @for (p of transferTargetProjects; track p.id) {
                <option [value]="p.id">{{ p.name }}</option>
              }
            </select>
          </div>
          <div class="dialog-actions">
            <button type="button" class="btn btn-outline" (click)="closeTransferDialog()">Ø§Ù†ØµØ±Ø§Ù</button>
            <button type="button" class="btn btn-primary" (click)="handleTransfer()" [disabled]="!newProjectId">Ø§Ù†ØªÙ‚Ø§Ù„</button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
